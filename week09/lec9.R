########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Example 7.2.1
alpha <- 0.05
gdp.all <- read.csv("http://astro.temple.edu/~zhaozhg/Stat8003/data/GDP_Per_Capita.csv")
gdp <- gdp.all[,62]
gdp[ is.na(gdp) ] <- NULL

l.gdp <- log( gdp )
n <- length( l.gdp ) 

l.gdp.Low <- mean( l.gdp ) - qt( 1-alpha/2, n-1 )* sqrt( var(l.gdp) )/sqrt(n)
l.gdp.Upp <- mean( l.gdp ) + qt( 1-alpha/2, n-1) * sqrt( var(l.gdp) )/sqrt(n)

########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Interpretation of the coverage probability.
library(plotrix)
theta <- 1
rep <- 20
ind <- c(1:rep)
Ls <- ind
Us <- ind
for(i in 1:rep)
  {
    Y <- rnorm( 10, theta, 1 )
    Ls[i] <- mean(Y) - qt( 1-alpha/2, 9) * sqrt( var( Y ) )/sqrt( 10 )
    Us[i] <- mean(Y) + qt( 1-alpha/2, 9) * sqrt( var( Y ) )/sqrt( 10 )
  }
plotCI(ind, Ls, Us )
points(c(1,rep), c(1,1), col='red','l')

### Coverage probability
theta <- 1
rep <- 2000
ind <- c(1:rep)
Ls <- ind
Us <- ind
for(i in 1:rep)
  {
    Y <- rnorm( 10, theta, 1 )
    Ls[i] <- mean(Y) - qt( 1-alpha/2, 9) * sqrt( var( Y ) )/sqrt( 10 )
    Us[i] <- mean(Y) + qt( 1-alpha/2, 9) * sqrt( var( Y ) )/sqrt( 10 )
  }
cov <- mean( (theta>Ls)*(theta<Us))

########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Example 7.2.2

## Equal tail interval
var.l.gdp <- var( l.gdp )
n <- length( l.gdp )

equal.Low <- (n-1)*var.l.gdp/ qchisq(1-alpha/2, n-1)
equal.Upp <- (n-1)*var.l.gdp/ qchisq(alpha/2, n-1)

## Cut the density
a.all <- c(1:9999)/10000 * qchisq( alpha, n-1 )
b.all <- qchisq( 1-alpha + pchisq(a.all, n-1), n-1 )
diff.den <- dchisq(a.all, n-1) - dchisq(b.all, n-1 )
ind <- which( abs(diff.den)==min(abs(diff.den) ) )
a <- a.all[ind]
b <- b.all[ind]
den.Low <- (n-1)*var.l.gdp/b
den.Upp <- (n-1)*var.l.gdp/a


########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Example 7.2.3
p.hat <- 0.41
N <- 1022
p.Low <- p.hat - qnorm( 1-alpha/2 )* sqrt( p.hat*(1-p.hat))/sqrt(N)
p.Upp <- p.hat + qnorm( 1-alpha/2 )* sqrt( p.hat*(1-p.hat))/sqrt(N)

## Simulate the coverage probability for small p
p <- 0.005
N <- 1022
numSim <- 1000
p.Lows <- rep(0, numSim)
p.Upps <- rep(0, numSim)

for(i in 1:numSim)
  {
    X <- rbinom(N, 1, p )
    p.hat <- mean(X)
    
    p.Lows[i] <- p.hat - qnorm( 1-alpha/2 )* sqrt( p.hat*(1-p.hat))/sqrt(N)
    p.Upps[i] <- p.hat + qnorm( 1-alpha/2 )* sqrt( p.hat*(1-p.hat))/sqrt(N)

  }
cov <- mean( (p>p.Lows)*(p<p.Upps) )


########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Interval using delta methods
p.hat <- 0.41
N <- 1022

vst.Low <- sin( asin( sqrt(p.hat) ) - qnorm( 1-alpha/2)/2/sqrt(N) )^2
vst.Upp <- sin( asin( sqrt(p.hat) ) + qnorm( 1-alpha/2)/2/sqrt(N) )^2

## Simulate the coverage probability for small p
p <- 0.005
N <- 1022
numSim <- 1000
vst.Lows <- rep(0, numSim)
vst.Upps <- rep(0, numSim)

for(i in 1:numSim)
  {
    X <- rbinom(N, 1, p )
    p.hat <- mean(X)
    
    vst.Lows[i] <- sin( asin( sqrt(p.hat) ) - qnorm( 1-alpha/2)/2/sqrt(N) )^2
    vst.Upps[i] <- sin( asin( sqrt(p.hat) ) + qnorm( 1-alpha/2)/2/sqrt(N) )^2

  }
vst.cov <- mean( (p>vst.Lows)*(p<vst.Upps) )

########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Using bootstrap
