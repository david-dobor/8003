########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
oilchange <- read.csv("http://astro.temple.edu/~zhaozhg/Stat8003/data/speedyoilchange.csv", header=FALSE)
plot( density( oilchange$V1 ) )
oilchange.xbar <- mean( oilchange$V1 )
oilchange.sSq <- var( oilchange$V1 )
oilchange.Tstat <- ( oilchange.xbar - 30 )/( sqrt( oilchange.sSq)/sqrt( length(oilchange$V1) ) ) 
oilchange.pvalue <- pt( oilchange.Tstat, length(oilchange$V1) -1 )

########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
1- pnorm( 1 )

########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Example 6.4.3
## (a)
pnorm( -1.96, 50*sqrt(10)/100, 1) + 1 - pnorm( 1.96, 50*sqrt(10)/100, 1)

## (b)
10000/2500* ( qnorm( 1- 0.05/2) + qnorm( 1- 0.2 ) )^2
pnorm( -1.96, 50*sqrt(32)/100, 1) + 1 - pnorm( 1.96, 50*sqrt(32)/100, 1)

########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Example 6.4.4
X <- read.table("http://astro.temple.edu/~zhaozhg/Stat8003/data/prostate_X.csv",sep=",")
Y <- read.table("http://astro.temple.edu/~zhaozhg/Stat8003/data/prostate_Y.csv",sep=",")

equalvar <- function(Xi, group)
  {
    n1 <- length( which(group==1) )
    n2 <- length( which(group==2) )
    mean1 <- mean(Xi[ group==1] )
    mean2 <- mean(Xi[ group==2] )
    s1 <- var( Xi[group==1] )
    s2 <- var( Xi[group==2] )

    s.pool <- ( (n1-1)*s1 + (n2-1)*s2 )/( n1+n2-2 )
    t.stat <- (mean1-mean2)/(s.pool*sqrt(1/n1+1/n2) )

    pvalue <- 2*pt( -abs(t.stat), n1+n2-2 )
    
  }

unequalvar <- function(Xi, group)
  {
    n1 <- length( which(group==1) )
    n2 <- length( which(group==2) )
    mean1 <- mean(Xi[ group==1] )
    mean2 <- mean(Xi[ group==2] )
    s1 <- var( Xi[group==1] )
    s2 <- var( Xi[group==2] )

    s.unpool <- (s1/n1 +s2/n2 )
    t.stat <- (mean1-mean2)/sqrt(s.unpool)
    df.sat <- (s1/n1+s2/n2)^2/( (s1/n1)^2/(n1-1) + (s2/n2)^2/(n2-1) )
    pvalue <- 2*pt( -abs( t.stat), df.sat )
    
  }
testvariance <- function(Xi, group )
  {
    n1 <- length( which(group==1) )
    n2 <- length( which(group==2) )
    s1 <- var( Xi[group==1] )
    s2 <- var( Xi[group==2] )

    F.stat <- s1/s2
    if( F.stat >1 ){
      pvalue <- 1-pf( abs( F.stat ), n1-1, n2-1 )
    }else{
       pvalue <- 1-pf( abs( 1/F.stat ), n2-1, n1-1 )
     }

  }

pvalue.equalvar <- apply( X, 1, equalvar, Y)
pvalue.unequalvar <- apply( X, 1, unequalvar, Y)
pvalue.ftest <- apply( X, 1, testvariance, Y)

## Consider gene 1720
den.control <- density(X[1720,][Y==1] )
den.treat <- density(X[1720,][Y==2] )
plot( den.control$x, den.control$y, 'l', main="Density under two conditions", xlab="expression", ylab="density", cex.main=2, cex.lab=1.5, col='red',lwd=3 )
points( den.treat$x, den.treat$y, 'l',  col='green', lwd=3 )
legend(x=0, y=1.0, col=c("red","green"), c("Control","Treatment"), lty=c(1,1), lwd=c(3,3), cex=2 )

ftest = pvalue.ftest[1720]
ttest = pvalue.unequalvar[1720]

## Consider gene 1
den.control.1 <- density(X[1,][Y==1] )
den.treat.1 <- density(X[1,][Y==2] )
plot( den.control.1$x, den.control.1$y, 'l', main="Density under two conditions", xlab="expression", ylab="density", cex.main=2, cex.lab=1.5, col='red',lwd=3 )
points( den.treat.1$x, den.treat.1$y, 'l',  col='green', lwd=3 )
legend(x=2, y=0.4, col=c("red","green"), c("Control","Treatment"), lty=c(1,1), lwd=c(3,3), cex=2 )



########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
#### Example 6.4.5
teachers <- read.table("http://astro.temple.edu/~zhaozhg/Stat8003/data/English_greek.csv",header=TRUE, sep=",")
diff <- teachers$English - teachers$Greek
T.stat <- ( mean(diff) )/sqrt( var(diff)/length(diff) )

t.test( teachers$English, teachers$Greek, paired=TRUE)
