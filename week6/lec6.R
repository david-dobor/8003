### RUn the EM algorithm for the faithful data
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
## EM algorithm

em = function(X,s) {
  ## W is the data set
  ## s is the parameter vector, where
  ### s[1] : pi0
  ### s[2] : mu0
  ### s[4]: sigma0^2
  ### s[3]: mu1
  ### s[5]: sigma1^2

  ## Estimate pi_0^{t+1}
  T0.all = s[1]*dnorm(X, s[2], sqrt(s[4]))/(s[1]*dnorm(X, s[2], sqrt(s[4])) + (1-s[1])*dnorm(X, s[3], sqrt(s[5])) )
  s[1] = mean(T0.all)

  ## Estimate mu0 and mu1
  s[2] = sum(T0.all*X) / sum(T0.all)
  s[3] = sum((1-T0.all)*X) / sum(1-T0.all)

  ## Estiamte sigma0^2 and sigma1^2
  s[4] = sum(T0.all*(X-s[2])^2) / sum(T0.all)
  s[5] = sum((1-T0.all)*(X-s[3])^2) / sum(1-T0.all)
  s
}


s.old <- c(0.5, 40, 90, 16, 16)
s.new <- s.old
delta <- 0.0001
Delta <- 1
ITR=1

while( Delta> delta ){
  s.new = em(X,s.old)
  Delta= sum( (s.new-s.old)^2 )
  Delta= max( abs(s.new-s.old) )
  ITR=ITR+1
  s.old=s.new
  print( paste(ITR, "-th iteration: pi0=", s.new[1], ", mu0=", s.new[2], ",sigma0=", sqrt( s.new[4]), ",mu1=", s.new[3], ",sigma1=", sqrt( s.new[5]) )  )
}
print( paste("Final estiamte: pi0=", s.new[1], ", mu0=", s.new[2], ",sigma0=", sqrt( s.new[4]), ",mu1=", s.new[3], ",sigma1=", sqrt( s.new[5]) )  )


pi0 <- s.new[1]
pi1 <- 1-pi0
mu0 <- s.new[2]
sigma0 <- sqrt( s.new[4] )
mu1 <- s.new[3]
sigma1 <- sqrt( s.new[5] )


########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
## Empirical cdf
X <- faithful$waiting
xaxis <- seq( min(X), max(X), 0.01)
emp.cdf <- xaxis
EM.cdf <- xaxis

for(i in 1:length( xaxis ) )
  {
    emp.cdf[i] <- mean( X <= xaxis[i] )
    EM.cdf[i] <- pi0 * pnorm( xaxis[i], mu0, sigma0 ) + pi1 * pnorm( xaxis[i], mu1, sigma1 )
  }

par( mfrow=c(2,1) )

## Recall the EM estiamtes
## postscript("figure/emp_cdf.eps", horizontal=FALSE)
plot( xaxis, emp.cdf, main="Simulated data", xlab="X", ylab="cdf", cex.main=2, cex.lab=1.5,'l', lwd=3, col='red' )
points( xaxis, EM.cdf, 'l', col='green', lwd=3  )
legend(50, 0.8, c("Empirical cdf", "cdf based on EM"), lty=c(1, 1), col=c('red', 'green'), lwd=c(3,3), cex=2 )
## dev.off()


#### Empirical cdf
X.gamma <- rgamma(100, 2, 2)
xaxis.gamma <- seq( min(X.gamma), max(X.gamma), 0.01)
emp.cdf.gamma <- xaxis.gamma
norm.cdf <- xaxis.gamma
mu.norm <- mean( X.gamma )
sigma.norm <- sqrt( var(X.gamma) )

for(i in 1:length( xaxis.gamma ) )
  {
    emp.cdf.gamma[i] <- mean( X.gamma <= xaxis.gamma[i] )
    norm.cdf[i] <- pnorm( xaxis.gamma[i], mu.norm, sigma.norm )
  }

plot( xaxis.gamma, emp.cdf.gamma, main="Waiting", xlab="Waiting", ylab="cdf", cex.main=2, cex.lab=1.5,'l', lwd=3, col='red' )
points( xaxis.gamma, norm.cdf, 'l', col='green', lwd=3  )
legend(1.0, 0.4, c("Empirical cdf", "cdf based on normal"), lty=c(1, 1), col=c('red', 'green'), lwd=c(3,3), cex=2 )


########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
## Example 6.2.3
type.I <- 1 - pbin(8, 25, 0.2)
type.II <- pbin( 8, 25, 0.5 )
power <- 1 - type.II

p.value <- 1 - pbin( 10, 25, 0.2 )


########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
## Example 6.3.1
Z.stat <- (17.3-17.6)/(1.3/sqrt(50) )
p.value <- 2 * pnorm( -abs( Z.stat ) )




########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
########################################################################################################################################################
## Example 6.3.2

# ------------------------------------------------------------------------
# Teenage Suicide Example: Hypothesis Testing
# ------------------------------------------------------------------------

suicide <-  c(1867,1789,1944,2094,2097,1981,1887,2024,1928,2039,1978,1859)
days <- c(31,28,31,30,31,30,31,31,30,31,30,31)
month <- 1:12
names(month) <- c("Jan","Feb","Mar","Apr","May","Jun",
                  "Jul","Aug","Sep","Oct","Nov","Dec")
dat <- data.frame(month,days,suicide,suicide/days)
names(dat) <- c("month","days","suicide","rate per day")
dat

#postscript(file=".figure/suicide.eps",horizontal=FALSE)
par(mfrow = c(1,2),oma = c(.5,.5,.5,.5))
plot(1:12,suicide,type = "b",ylab = "Number of Teenage Suicide",
     xlab = "Month", xaxt = "n")
axis(1, at = 1:12, labels = names(month))
plot(1:12, suicide/days, type="b", ylab="Rate of Tennage suicides",
     xlab = "Month", xaxt="n")
axis(1, at=1:12, labels = names(month))
#dev.off()

eio <- days/365*sum(suicide)
two.log.lambda <- 2*sum(suicide*(log(suicide)-log(eio)))
cat("two.log.lambda is", two.log.lambda,"\n")

cutoff <- qchisq(.95,11)
cat("Cutoff is", cutoff, "\n")

p.val <- 1 - pchisq(two.log.lambda,11)
cat("pvalue is", p.val, "\n")
